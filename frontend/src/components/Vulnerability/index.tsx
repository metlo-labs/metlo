import React, { useState } from "react"
import { useRouter } from "next/router"
import { Box, Heading, VStack } from "@chakra-ui/react"
import { ContentContainer } from "components/utils/ContentContainer"
import { VulnerabilitySummary } from "@common/types"
import { GetVulnerabilityAggParams } from "@common/api/summary"
import SensitiveDataFilters from "./Filters"
import List from "./List"
import AggVulnerabilityChart from "./AggVulnerabilityChart"

interface VulnerabilityPageProps {
  summary: VulnerabilitySummary
  hosts: string[]
  params: GetVulnerabilityAggParams
}

const VulnerabilityPage: React.FC<VulnerabilityPageProps> = React.memo(
  ({ summary, hosts, params }) => {
    const [fetching, setFetching] = useState<boolean>(false)
    const router = useRouter()

    const setParams = (newParams: GetVulnerabilityAggParams) => {
      setFetching(true)
      newParams = { ...params, ...newParams }
      router.push({
        query: {
          riskScores: newParams.riskScores?.join(",") ?? "",
          hosts: newParams.hosts?.join(",") ?? "",
        },
      })
    }

    return (
      <ContentContainer maxContentW="100rem" px="8" py="8">
        <VStack w="full" alignItems="flex-start">
          <Heading fontWeight="medium" size="lg" mb="4">
            Vulnerabilities
          </Heading>
        </VStack>
        <VStack
          w="full"
          alignItems="flex-start"
          borderWidth="1px"
          rounded="md"
          spacing="0"
          overflow="hidden"
        >
          <Box p="4" borderBottom="1px" borderColor="inherit" w="full">
            <SensitiveDataFilters
              hostList={hosts}
              hosts={params.hosts}
              riskScores={params.riskScores}
              setParams={setParams}
            />
          </Box>
          <AggVulnerabilityChart
            vulnerabilityTypeCount={summary.vulnerabilityTypeCount}
            totalVulnerabilities={summary.totalVulnerabilities}
            totalEndpoints={summary.totalEndpoints}
          />
          <Box w="full" borderTop="1px" borderColor="inherit">
            <List items={summary.vulnerabilityItems} params={params} />
          </Box>
        </VStack>
      </ContentContainer>
    )
  },
)

export default VulnerabilityPage
